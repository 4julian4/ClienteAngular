<!-- src/app/componentes/nomina-electronica/nomina-electronica.component.html -->

<h2 class="title">Nómina Electrónica</h2>

<div class="toolbar">
  <!-- Tipo de listado: pendientes / creadas -->
  <mat-form-field appearance="fill">
    <mat-label>Listado</mat-label>
    <mat-select [(ngModel)]="tipoListado">
      <mat-option value="pendientes">Pendientes</mat-option>
      <mat-option value="creadas">Creadas</mat-option>
    </mat-select>
  </mat-form-field>

  <!-- Empleado (texto libre) -->
  <mat-form-field appearance="fill">
    <mat-label>Empleado</mat-label>
    <input matInput [(ngModel)]="filtro.empleado" />
  </mat-form-field>

  <!-- Fechas -->
  <mat-form-field appearance="fill">
    <mat-label>Fecha inicio</mat-label>
    <input matInput [matDatepicker]="fi" [(ngModel)]="filtro.fechaInicio" />
    <mat-datepicker-toggle matSuffix [for]="fi"></mat-datepicker-toggle>
    <mat-datepicker #fi></mat-datepicker>
  </mat-form-field>

  <mat-form-field appearance="fill">
    <mat-label>Fecha fin</mat-label>
    <input matInput [matDatepicker]="ff" [(ngModel)]="filtro.fechaFin" />
    <mat-datepicker-toggle matSuffix [for]="ff"></mat-datepicker-toggle>
    <mat-datepicker #ff></mat-datepicker>
  </mat-form-field>

  <div class="toolbar__cta">
    <!-- Botón blanco -->
    <button mat-stroked-button class="btn-buscar" (click)="buscar()">
      Buscar
    </button>

    <!-- Botón azul personalizado -->
    <button mat-raised-button class="btn-primario" (click)="abrirCrearNomina()">
      Crear nómina
    </button>

    <!-- Botón presentar solo si estamos en pendientes y hay selección -->
    <button
      mat-raised-button
      class="btn-primario"
      *ngIf="tipoListado === 'pendientes' && seleccionadas.size"
      (click)="presentarSeleccionadas()"
    >
      Presentar ({{ seleccionadas.size }})
    </button>
  </div>
</div>

<div class="tabla-wrapper">
  <div class="tabla-scroll">
    <table
      mat-table
      [dataSource]="lista"
      class="tabla mat-elevation-z2"
      *ngIf="!cargando; else cargandoTpl"
    >
      <!-- SELECCIÓN: solo para pendientes -->
      <ng-container matColumnDef="select" *ngIf="tipoListado === 'pendientes'">
        <th mat-header-cell *matHeaderCellDef class="col-select">
          <mat-checkbox
            (change)="seleccionarTodo()"
            [checked]="seleccionadas.size === lista.length && lista.length > 0"
          ></mat-checkbox>
        </th>
        <td mat-cell *matCellDef="let r" class="col-select">
          <mat-checkbox
            (change)="toggle(r)"
            [checked]="seleccionadas.has(r.id)"
          ></mat-checkbox>
        </td>
      </ng-container>

      <!-- Prefijo -->
      <ng-container matColumnDef="prefix">
        <th mat-header-cell *matHeaderCellDef>Prefijo</th>
        <td mat-cell *matCellDef="let r">{{ r.prefix }}</td>
      </ng-container>

      <!-- Número -->
      <ng-container matColumnDef="number">
        <th mat-header-cell *matHeaderCellDef>Número</th>
        <td mat-cell *matCellDef="let r">{{ r.number }}</td>
      </ng-container>

      <!-- Empleado -->
      <ng-container matColumnDef="empleado">
        <th mat-header-cell *matHeaderCellDef>Empleado</th>
        <td mat-cell *matCellDef="let r">
          {{ r.employeeName }}<br />
          <small class="muted">{{ r.employeeId }}</small>
        </td>
      </ng-container>

      <!-- Fechas -->
      <ng-container matColumnDef="fechas">
        <th mat-header-cell *matHeaderCellDef>Fechas</th>
        <td mat-cell *matCellDef="let r">
          <div>Emisión: {{ r.issueDate }}</div>
          <div>Pago: {{ r.paymentDate }}</div>
        </td>
      </ng-container>

      <!-- Estado -->
      <ng-container matColumnDef="estado">
        <th mat-header-cell *matHeaderCellDef>Estado</th>
        <td mat-cell *matCellDef="let r">
          <div>
            <span class="pill" [class.ok]="r.dianStatus === 'DIAN_ENVIADO'">
              {{ r.dianStatus || "-" }}
            </span>
          </div>
          <div>
            <small class="muted">
              {{ r.estadoPresentacion }}
            </small>
          </div>
        </td>
      </ng-container>

      <!-- Acciones -->
      <ng-container matColumnDef="acciones">
        <th mat-header-cell *matHeaderCellDef>Acciones</th>
        <td mat-cell *matCellDef="let r" class="acciones-cell">
          <button
            mat-icon-button
            [matMenuTriggerFor]="menuAcciones"
            matTooltip="Acciones"
          >
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #menuAcciones="matMenu">
            <!-- PENDIENTES -->
            <ng-container *ngIf="tipoListado === 'pendientes'">
              <button mat-menu-item (click)="presentarUna(r)">
                <mat-icon>cloud_upload</mat-icon>
                <span>Presentar en DIAN</span>
              </button>
            </ng-container>

            <!-- CREADAS -->
            <ng-container *ngIf="tipoListado === 'creadas'">
              <button mat-menu-item (click)="descargarPdf(r)">
                <mat-icon>picture_as_pdf</mat-icon>
                <span>Descargar PDF</span>
              </button>

              <button mat-menu-item (click)="descargarXml(r)">
                <mat-icon>code</mat-icon>
                <span>Descargar XML</span>
              </button>

              <mat-divider></mat-divider>

              <button mat-menu-item (click)="abrirReemplazo(r)">
                <mat-icon>sync</mat-icon>
                <span>Reemplazar nómina</span>
              </button>

              <button mat-menu-item (click)="abrirEliminacion(r)">
                <mat-icon>delete</mat-icon>
                <span>Eliminar nómina</span>
              </button>
            </ng-container>
          </mat-menu>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="columnasVisibles"></tr>
      <tr mat-row *matRowDef="let row; columns: columnasVisibles"></tr>
    </table>
  </div>
</div>

<ng-template #cargandoTpl>
  <div class="cargando">
    <mat-spinner diameter="40"></mat-spinner>
  </div>
</ng-template>
