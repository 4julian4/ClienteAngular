<div class="toolbar">
  <!-- Tipo de listado -->
  <mat-form-field appearance="fill">
    <mat-label>Listado</mat-label>
    <mat-select [formControl]="filtroTipoListado">
      <mat-option value="pendientes">Pendientes</mat-option>
      <mat-option value="creadas">Creadas</mat-option>
    </mat-select>
  </mat-form-field>

  <!-- N° Factura (solo para “creadas”) -->
  <mat-form-field
    appearance="fill"
    *ngIf="filtroTipoListado.value === 'creadas'"
  >
    <mat-label>N° factura (opcional)</mat-label>
    <input
      matInput
      placeholder="Ej: F001-123"
      [formControl]="filtroNumeroFactura"
    />
  </mat-form-field>

  <!-- Nuevo: filtro por DOCTOR (usa listaDoctores) -->
  <mat-form-field appearance="fill">
    <mat-label>Doctor responsable</mat-label>
    <mat-select [formControl]="filtroDoctor">
      <!-- Opción para consultar todos los doctores -->
      <mat-option value="TODOS">Todos los doctores</mat-option>

      <!-- Una opción por cada doctor -->
      <mat-option *ngFor="let doc of listaDoctores" [value]="doc.id">
        {{ doc.nombre }}
      </mat-option>
    </mat-select>
  </mat-form-field>

  <!-- Texto libre -->
  <mat-form-field appearance="fill">
    <mat-label>Buscar</mat-label>
    <input
      matInput
      placeholder="Paciente, factura, prestador…"
      [formControl]="filtroTexto"
    />
  </mat-form-field>

  <!-- Fechas -->
  <mat-form-field appearance="fill">
    <mat-label>Fecha inicial</mat-label>
    <input matInput [matDatepicker]="dp1" [formControl]="filtroFechaIni" />
    <mat-datepicker-toggle matSuffix [for]="dp1"></mat-datepicker-toggle>
    <mat-datepicker #dp1></mat-datepicker>
  </mat-form-field>

  <mat-form-field appearance="fill">
    <mat-label>Fecha final</mat-label>
    <input matInput [matDatepicker]="dp2" [formControl]="filtroFechaFin" />
    <mat-datepicker-toggle matSuffix [for]="dp2"></mat-datepicker-toggle>
    <mat-datepicker #dp2></mat-datepicker>
  </mat-form-field>

  <!-- Acciones de la toolbar + progreso -->
  <div class="toolbar__cta">
    <!-- Chip de progreso (se muestra solo si total > 0) 
    <ng-container *ngIf="progreso$ | async as p">
      <span
        *ngIf="p.total > 0"
        class="chip-progreso"
        matTooltip="Avance de presentación"
      >
        {{ p.processed }}/{{ p.total }} · OK {{ p.ok }} · Fail {{ p.fail }}
      </span>
    </ng-container>-->

    <!--<button class="btn-primario" mat-raised-button (click)="consultar()">
      Consultar
    </button>-->
    <button
      class="btn-primario"
      mat-raised-button
      (click)="consultar()"
      [disabled]="isPresentandoDian"
    >
      Consultar
    </button>
    <!-- Botón masivo: solo en pendientes y si hay selección -->
    <button
      *ngIf="filtroTipoListado.value === 'pendientes' && selection.hasValue()"
      mat-raised-button
      class="btn-primario"
      style="margin-left: 8px"
      (click)="presentarSeleccionadas()"
      [disabled]="isPresentandoDian"
    >
      Presentar
      <!--({{ selection.selected.length }})-->
    </button>
  </div>
</div>

<div class="tabla-wrapper" *ngIf="!isLoading; else cargandoTpl">
  <div class="tabla-scroll">
    <table
      mat-table
      [dataSource]="dataSource"
      matSort
      [multiTemplateDataRows]="true"
      class="mat-elevation-z8 tabla"
      [trackBy]="trackByRow"
    >
      <!-- Columna de selección (solo para 'pendientes') -->
      <ng-container
        *ngIf="filtroTipoListado.value === 'pendientes'"
        matColumnDef="select"
      >
        <th mat-header-cell *matHeaderCellDef class="col-select">
          <mat-checkbox
            [indeterminate]="isIndeterminate()"
            [checked]="isAllSelected()"
            (change)="masterToggle()"
            aria-label="Seleccionar todas las facturas pendientes"
          >
          </mat-checkbox>
        </th>

        <td mat-cell *matCellDef="let r" class="col-select">
          <mat-checkbox
            (click)="$event.stopPropagation()"
            (change)="toggleRow(r)"
            [checked]="selection.isSelected(r)"
            aria-label="Seleccionar esta factura"
          >
          </mat-checkbox>
        </td>
      </ng-container>

      <!-- Fecha -->
      <ng-container matColumnDef="fecha">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Fecha</th>
        <td mat-cell *matCellDef="let r">
          {{ r.fecha | date: "dd/MM/yyyy" }}
        </td>
      </ng-container>

      <!-- Factura -->
      <ng-container matColumnDef="factura">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Factura</th>
        <td mat-cell *matCellDef="let r">{{ r.factura }}</td>
      </ng-container>

      <!-- Paciente -->
      <ng-container matColumnDef="nombrePaciente">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Paciente</th>
        <td mat-cell *matCellDef="let r">{{ r.nombre_Paciente }}</td>
      </ng-container>

      <!-- Documento -->
      <ng-container matColumnDef="documentoPaciente">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Documento</th>
        <td mat-cell *matCellDef="let r">{{ r.documento }}</td>
      </ng-container>

      <!-- Valor -->
      <ng-container matColumnDef="valorTotal">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Valor</th>
        <td mat-cell *matCellDef="let r">
          {{ r.valor_Total | number: "1.0-0" }}
        </td>
      </ng-container>

      <!-- Prestador -->
      <ng-container matColumnDef="prestador">
        <th
          mat-header-cell
          *matHeaderCellDef
          mat-sort-header
          class="col-prestador"
        >
          Prestador
        </th>
        <td mat-cell *matCellDef="let r" class="col-prestador">
          {{ r.prestador }}
        </td>
      </ng-container>

      <!-- Doctor (solo existe en pendientes; si no, muestra “-”) -->
      <ng-container matColumnDef="doctor">
        <th
          mat-header-cell
          *matHeaderCellDef
          mat-sort-header
          class="col-doctor"
        >
          Doctor
        </th>
        <td mat-cell *matCellDef="let r" class="col-doctor">
          {{ getDoctor(r) }}
        </td>
      </ng-container>

      <!-- Cápsula NC (solo en creadas) -->
      <ng-container matColumnDef="ncTag">
        <th mat-header-cell *matHeaderCellDef class="col-notas">Notas</th>
        <td mat-cell *matCellDef="let r" class="col-notas">
          <span *ngIf="tieneNc(r)" class="pill pill--nc pill--mini">NC</span>
        </td>
      </ng-container>

      <!-- Acciones -->
      <ng-container matColumnDef="acciones">
        <th mat-header-cell *matHeaderCellDef class="col-acciones">Acciones</th>
        <td mat-cell *matCellDef="let r" class="col-acciones">
          <button
            mat-icon-button
            [matMenuTriggerFor]="menuAcciones"
            matTooltip="Acciones"
            (click)="$event.stopPropagation()"
          >
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #menuAcciones="matMenu">
            <!-- Pendientes -->
            <ng-container *ngIf="filtroTipoListado.value === 'pendientes'">
              <button
                mat-menu-item
                (click)="registrarEnDian(r)"
                [disabled]="isPresentandoDian"
              >
                <mat-icon>cloud_upload</mat-icon>
                <span>Registrar en DIAN</span>
              </button>
              <button mat-menu-item (click)="descargarJsonPendiente(r)">
                <mat-icon>download</mat-icon>
                <span>Descargar JSON</span>
              </button>
            </ng-container>

            <!-- Creadas -->
            <ng-container *ngIf="filtroTipoListado.value === 'creadas'">
              <button mat-menu-item (click)="descargarPdf(r)">
                <mat-icon>picture_as_pdf</mat-icon>
                <span>Descargar PDF</span>
              </button>
              <button mat-menu-item (click)="descargarXml(r)">
                <mat-icon>download</mat-icon>
                <span>Descargar XML</span>
              </button>

              <mat-divider></mat-divider>

              <!-- Crear Notas -->
              <!--
              <button mat-menu-item (click)="abrirCrearNota('NC', r)">
                <mat-icon>note_add</mat-icon>
                <span>Crear Nota Crédito (NC)</span>
              </button>
              -->
              <!--
              <button mat-menu-item (click)="abrirCrearNota('ND', r)">
                <mat-icon>note_add</mat-icon>
                <span>Crear Nota Débito (ND)</span>
              </button>
              -->

              <button
                mat-menu-item
                (click)="abrirCrearNota('NC', r)"
                [disabled]="tieneNc(r)"
                matTooltip="Esta factura ya tiene Nota Crédito. No se permiten más notas."
              >
                <mat-icon>note_add</mat-icon>
                <span>Crear Nota Crédito (NC)</span>
              </button>

              <mat-divider></mat-divider>

              <!-- Ver notas (fila de detalle) -->
              <button mat-menu-item (click)="verNotasFactura(r)">
                <mat-icon>list</mat-icon>
                <span>Ver notas de esta factura</span>
              </button>
            </ng-container>
          </mat-menu>
        </td>
      </ng-container>

      <!-- ====== Fila de detalle (panel de notas debajo de la factura) ====== -->
      <ng-container matColumnDef="expandedDetail">
        <td
          mat-cell
          *matCellDef="let row"
          class="detalle-notas-cell"
          [attr.colspan]="displayedColumns.length"
        >
          <div
            class="detalle-notas"
            *ngIf="notaPanelFactura === row"
            (click)="$event.stopPropagation()"
          >
            <div class="detalle-notas__header">
              <div class="detalle-notas__title">
                Notas de la factura
                <strong>{{ row.factura }}</strong>
              </div>
              <button
                mat-icon-button
                class="detalle-notas__close"
                (click)="cerrarPanelNotas($event)"
              >
                <mat-icon>close</mat-icon>
              </button>
            </div>

            <ng-container
              *ngIf="notasFacturaSeleccionada.length; else sinNotasTpl"
            >
              <table class="detalle-notas__tabla">
                <thead>
                  <tr>
                    <th>Tipo</th>
                    <th>Número</th>
                    <th>Fecha</th>
                    <th>Valor</th>
                    <th>Estado DIAN</th>
                    <th>Estado interno</th>
                    <th class="col-acciones-nota">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let n of notasFacturaSeleccionada">
                    <td>
                      <span
                        class="pill"
                        [class.pill--nc]="n.noteType === 'NC'"
                        [class.pill--nd]="n.noteType === 'ND'"
                      >
                        {{ n.noteType }}
                      </span>
                    </td>

                    <td>{{ n.number }}</td>
                    <td>{{ n.issueDate }}</td>

                    <td>{{ n.totalAmount || 0 | number: "1.0-0" }}</td>

                    <td>
                      <span
                        class="pill pill--estado"
                        [class.pill--ok]="n.dianStatus === 'ACEPTADO'"
                      >
                        {{ n.dianStatus || "-" }}
                      </span>
                    </td>

                    <td>
                      <small class="muted">
                        {{ n.internalStatus || "-" }}
                      </small>
                    </td>

                    <td class="col-acciones-nota">
                      <button
                        mat-icon-button
                        [matMenuTriggerFor]="menuNota"
                        (click)="$event.stopPropagation()"
                        matTooltip="Acciones de la nota"
                      >
                        <mat-icon>more_vert</mat-icon>
                      </button>

                      <mat-menu #menuNota="matMenu">
                        <!-- Descargar PDF (solo habilitado si hay pdfUrl) -->
                        <button
                          mat-menu-item
                          (click)="descargarPdfNota(n, $event)"
                          [disabled]="!n.pdfUrl"
                        >
                          <mat-icon>picture_as_pdf</mat-icon>
                          <span>Ver PDF</span>
                        </button>

                        <!-- Descargar XML (solo habilitado si hay xmlUrl) -->
                        <button
                          mat-menu-item
                          (click)="descargarXmlNota(n, $event)"
                          [disabled]="!n.xmlUrl"
                        >
                          <mat-icon>download</mat-icon>
                          <span>Ver XML</span>
                        </button>

                        <mat-divider></mat-divider>

                        <!-- Editar -->
                        <button
                          mat-menu-item
                          (click)="editarNota(n, $event)"
                          [disabled]="esNotaBloqueada(n)"
                        >
                          <mat-icon>edit</mat-icon>
                          <span>Editar</span>
                        </button>

                        <!-- Eliminar -->
                        <button
                          mat-menu-item
                          (click)="borrarNota(n, $event)"
                          [disabled]="esNotaBloqueada(n)"
                        >
                          <mat-icon>delete</mat-icon>
                          <span>Eliminar</span>
                        </button>
                      </mat-menu>
                    </td>
                  </tr>
                </tbody>
              </table>
            </ng-container>

            <ng-template #sinNotasTpl>
              <div class="detalle-notas__empty">
                No hay notas aún para esta factura.
              </div>
            </ng-template>
          </div>
        </td>
      </ng-container>

      <!-- Filas principales -->
      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>

      <tr
        mat-row
        *matRowDef="let row; columns: displayedColumns"
        class="factura-row"
      ></tr>

      <!-- Fila de detalle: una por cada row, solo se ve la que coincide -->
      <tr
        mat-row
        *matRowDef="let row; columns: ['expandedDetail']"
        class="detalle-notas-row"
        [class.detalle-notas-row--visible]="notaPanelFactura === row"
      ></tr>
    </table>
  </div>

  <mat-paginator
    [pageSize]="10"
    [pageSizeOptions]="[10, 25, 50]"
    showFirstLastButtons
  >
  </mat-paginator>
</div>

<ng-template #cargandoTpl>
  <div class="cargando">
    <mat-spinner></mat-spinner>
  </div>
</ng-template>

<!-- ✅ Overlay pro DIAN (igual a RIPS) -->
<div class="overlay-loading" *ngIf="isPresentandoDian">
  <div class="overlay-card">
    <mat-spinner diameter="42"></mat-spinner>

    <div class="overlay-title">Presentando en DIAN…</div>
    <div class="overlay-subtitle">{{ dianProgressLabel }}</div>

    <mat-progress-bar
      class="overlay-bar"
      mode="determinate"
      [value]="dianProgressPercent"
    ></mat-progress-bar>

    <div class="overlay-stats" *ngIf="progresoActual as p">
      <div><b>Total:</b> {{ p.total || 0 }}</div>
      <div><b>Procesadas:</b> {{ p.processed || 0 }}</div>
      <div><b>OK:</b> {{ p.ok || 0 }}</div>
      <div><b>Fallidas:</b> {{ p.fail || 0 }}</div>

      <div class="overlay-last" *ngIf="p.lastDocumento">
        <b>Última:</b> {{ p.lastDocumento }}
      </div>

      <div class="overlay-last" *ngIf="p.lastExternalId">
        <b>UUID:</b> {{ p.lastExternalId }}
      </div>
    </div>

    <div class="overlay-hint">
      No cierres esta ventana. Al finalizar verás el resumen.
    </div>
  </div>
</div>
