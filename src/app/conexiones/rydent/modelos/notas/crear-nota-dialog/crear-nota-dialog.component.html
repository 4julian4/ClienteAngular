<!-- ClienteAngular/src/app/conexiones/rydent/modelos/notas/crear-nota-dialog/crear-nota-dialog.component.html -->

<h2 mat-dialog-title class="title">
  Nueva Nota {{ notaTipoLabel }} para factura {{ facturaNumero }}
</h2>

<mat-dialog-content class="content">
  <form [formGroup]="form" class="nota-form">
    <!-- ENCABEZADO COMPACTO -->
    <section class="section section--encabezado">
      <div class="header-grid">
        <div class="field">
          <label class="field-label">Fecha de emisión*</label>
          <input type="date" class="field-input" formControlName="issueDate" />
        </div>

        <div class="field">
          <label class="field-label">Razón**</label>
          <select class="field-input" formControlName="reason">
            <option value="" disabled>Seleccione un motivo</option>
            <!-- Solo ANULACION para NC -->
            <option
              *ngFor="let motivo of reasonsPorTipo"
              [value]="motivo"
              [hidden]="notaTipoLabel === 'NC' && motivo !== 'ANULACION'"
            >
              {{ motivo }}
            </option>
            <!--
            <option *ngFor="let motivo of reasonsPorTipo" [value]="motivo">
              {{ motivo }}
            </option>
            -->
          </select>
        </div>

        <div class="field">
          <label class="field-label">Tercero</label>
          <input
            class="field-input field-input--readonly"
            type="text"
            [value]="terceroNombre"
            readonly
          />
        </div>

        <div class="field">
          <label class="field-label">Método de pago</label>
          <input
            class="field-input field-input--readonly"
            type="text"
            [value]="metodoPagoLabel"
            readonly
          />
        </div>
      </div>
    </section>

    <!-- CUERPO -->
    <div class="scroll-body">
      <!-- ÍTEMS -->
      <section class="section section--items">
        <div class="items-table-wrapper" formArrayName="items">
          <!-- ✅ Scroll SOLO para ítems (si crecen) -->
          <div class="items-table-scroll">
            <div class="items-table">
              <!-- Encabezado -->
              <div class="items-header-row">
                <div class="th th--idx">#</div>
                <div class="th">REF*</div>
                <div class="th">DESCRIPCIÓN*</div>
                <div class="th th--numeric">CANT</div>
                <div class="th th--numeric">PRECIO</div>
                <div class="th th--numeric">DESC %</div>
                <div class="th th--numeric">RET. FTE</div>
                <div class="th th--numeric">IMPUESTO</div>
                <div class="th th--numeric">SUBTOTAL</div>
                <div class="th th--numeric">TOTAL</div>
                <div class="th th--acciones"></div>
              </div>

              <!-- Filas -->
              <div
                class="item-row"
                *ngFor="
                  let itemCtrl of itemsFormArray.controls;
                  let i = index;
                  trackBy: trackByItemIndex
                "
                [formGroupName]="i"
              >
                <div class="td td--idx">{{ i + 1 }}</div>

                <div class="td">
                  <input
                    class="field-input field-input--sm"
                    formControlName="sku"
                    placeholder="REF"
                    [readonly]="!!itemCtrl.get('sku')?.disabled"
                  />
                </div>

                <div class="td">
                  <input
                    class="field-input"
                    formControlName="description"
                    placeholder="Descripción"
                    [readonly]="!!itemCtrl.get('description')?.disabled"
                  />
                </div>

                <div class="td td--numeric">
                  <input
                    class="field-input field-input--number"
                    type="number"
                    min="0"
                    max="9999"
                    formControlName="quantity"
                    [readonly]="!!itemCtrl.get('quantity')?.disabled"
                  />
                  <div
                    *ngIf="itemCtrl.get('quantity')?.errors"
                    class="error-message"
                  >
                    <span
                      *ngIf="itemCtrl.get('quantity')?.errors?.['maxQuantity']"
                    >
                      {{ itemCtrl.get("quantity")?.errors?.["maxQuantity"] }}
                    </span>
                    <span
                      *ngIf="
                        itemCtrl.get('quantity')?.errors?.['fixedQuantity']
                      "
                    >
                      {{ itemCtrl.get("quantity")?.errors?.["fixedQuantity"] }}
                    </span>
                  </div>
                </div>

                <div class="td td--numeric">
                  <input
                    class="field-input field-input--number"
                    type="number"
                    min="0"
                    max="999999"
                    formControlName="price"
                    [readonly]="!!itemCtrl.get('price')?.disabled"
                  />
                </div>

                <div class="td td--numeric">
                  <input
                    class="field-input field-input--number"
                    type="number"
                    min="0"
                    max="100"
                    formControlName="discountRate"
                    [readonly]="!!itemCtrl.get('discountRate')?.disabled"
                  />
                </div>

                <div class="td td--numeric">
                  <select
                    class="field-input field-input--select"
                    formControlName="retFuenteRate"
                    [disabled]="!!itemCtrl.get('retFuenteRate')?.disabled"
                  >
                    <option *ngFor="let r of retFuenteOptions" [ngValue]="r">
                      {{ r }}%
                    </option>
                  </select>
                </div>

                <div class="td td--numeric">
                  <select
                    class="field-input field-input--select"
                    formControlName="ivaRate"
                    [disabled]="!!itemCtrl.get('ivaRate')?.disabled"
                  >
                    <option *ngFor="let iva of ivaOptions" [ngValue]="iva">
                      IVA {{ iva }}%
                    </option>
                  </select>
                </div>

                <div class="td td--numeric">
                  <span class="monto">
                    {{
                      calcularSubtotalFila(i)
                        | currency: "COP" : "symbol" : "1.0-0"
                    }}
                  </span>
                </div>

                <div class="td td--numeric">
                  <span class="monto">
                    {{
                      calcularTotalFila(i)
                        | currency: "COP" : "symbol" : "1.0-0"
                    }}
                  </span>
                </div>

                <div class="td td--acciones">
                  <button
                    *ngIf="reasonConfig?.allowAddRemoveItems"
                    type="button"
                    class="icon-button"
                    (click)="eliminarLinea(i)"
                    aria-label="Eliminar línea"
                  >
                    ✕
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Footer items -->
        <div class="items-footer-row">
          <button
            type="button"
            class="link-button"
            (click)="agregarLinea()"
            [disabled]="!reasonConfig?.allowAddRemoveItems"
          >
            + Línea
          </button>

          <span class="hint">
            Para algunos motivos (ANULACIÓN, DEVOLUCIÓN, AJUSTE, etc.), los
            ítems se pueden llenar automáticamente leyendo la factura.
          </span>
        </div>
      </section>

      <!-- NOTAS + TOTALES -->
      <section class="section section--bottom">
        <div class="bottom-layout">
          <div class="bottom-left">
            <div class="section section--notas">
              <div class="notas-header">
                <span class="section__subtitle">Notas</span>
                <button
                  type="button"
                  class="icon-circle"
                  (click)="addNote()"
                  aria-label="Agregar nota"
                >
                  +
                </button>
              </div>

              <div class="notas-list" *ngIf="notesList.length; else notasEmpty">
                <div
                  class="nota-row"
                  *ngFor="let nota of notesList; let i = index"
                >
                  <input
                    class="nota-input"
                    type="text"
                    [value]="nota"
                    (input)="onNoteInput(i, $any($event.target).value)"
                    placeholder="Agregar notas de numeración"
                  />
                  <button
                    type="button"
                    class="nota-remove"
                    (click)="removeNote(i)"
                    aria-label="Quitar nota"
                  >
                    ×
                  </button>
                </div>
              </div>

              <ng-template #notasEmpty>
                <p class="notas-empty">
                  No hay notas. Usa el botón <strong>+</strong> para agregar.
                </p>
              </ng-template>
            </div>
          </div>

          <div class="bottom-right">
            <div class="totales-panel">
              <div class="totales-row totales-row--muted">
                <span>Subtotal</span>
                <span class="monto">{{
                  totales.subtotal | currency: "COP" : "symbol" : "1.0-0"
                }}</span>
              </div>

              <div class="totales-row totales-row--link">
                <button
                  type="button"
                  class="link-button"
                  (click)="abrirCargosDescuentos()"
                  [disabled]="!reasonConfig?.allowGlobalAdjustment"
                >
                  + Cargo / Descuento
                </button>
              </div>

              <div class="totales-row totales-row--muted">
                <span>IVA ({{ totales.ivaPorcentaje }}%)</span>
                <span class="monto">{{
                  totales.ivaValor | currency: "COP" : "symbol" : "1.0-0"
                }}</span>
              </div>

              <div class="totales-row totales-row--muted">
                <span>Ret. FUENTE</span>
                <span class="monto">{{
                  totales.retFuente | currency: "COP" : "symbol" : "1.0-0"
                }}</span>
              </div>

              <div class="totales-row totales-row--muted">
                <span>Ret. ICA</span>
                <span class="monto">{{
                  totales.retIca | currency: "COP" : "symbol" : "1.0-0"
                }}</span>
              </div>

              <div class="totales-divider"></div>

              <div class="totales-row totales-row--total">
                <span>Total</span>
                <span class="monto">{{
                  totales.total | currency: "COP" : "symbol" : "1.0-0"
                }}</span>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <div class="hidden-fields"></div>
  </form>
</mat-dialog-content>

<mat-dialog-actions class="acciones">
  <button mat-button type="button" (click)="cancelar()">Cancelar</button>
  <button
    mat-flat-button
    color="primary"
    type="button"
    [disabled]="form.invalid || loading()"
    (click)="guardar()"
  >
    Guardar
  </button>

  <span *ngIf="loading()" class="loading-overlay">
    <span class="spin">⏳</span> Guardando…
  </span>
</mat-dialog-actions>
